<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAO Master Suite v4</title>
    <style>
        :root {
            --bg: #121212;
            --surface: #2a2e35;
            --primary: #4682b4;
            --accent: #ffd700;
            --text-main: #e0e0e0;
            --text-dim: #6c757d;
            --success: #2e7d32;
            --danger: #c62828;
            --neon: #00f3ff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
        }

        .app-container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            width: 95%;
            max-width: 900px;
            min-height: 700px;
            text-align: center;
            border: 1px solid var(--text-dim);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* NAVIGATION */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--text-dim);
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .nav-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 15px rgba(70, 130, 180, 0.4); }

        /* SECTIONS */
        .mode-section { display: none; flex-direction: column; height: 100%; flex: 1; }
        .mode-section.active { display: flex; }

        /* COMMON COMPONENTS */
        h1 { color: var(--accent); margin: 0 0 10px 0; font-size: 2.5rem; }
        p { color: var(--text-dim); margin-bottom: 20px; }

        .stat-grid { display: flex; justify-content: space-around; margin-bottom: 20px; width: 100%; }
        .stat-box { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); }
        .stat-val { font-size: 1.5rem; font-weight: 900; color: var(--text-main); display: block; }
        
        .timer-huge { font-family: monospace; font-size: 4rem; font-weight: bold; color: white; margin: 10px 0; }
        .timer-danger { color: var(--danger); animation: pulse 0.5s infinite; }

        /* CARDS */
        .prompt-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            cursor: pointer;
            transition: border 0.2s;
        }
        .prompt-card:hover { border-color: var(--primary); }
        
        .big-number { font-size: 5rem; font-weight: 900; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        /* SPEED READER SPECIFIC */
        .pao-row { display: flex; gap: 20px; justify-content: center; width: 100%; align-items: center; }
        .pao-digit { text-align: center; }
        .pao-num { font-size: 4rem; font-weight: 900; font-family: monospace; color: white; letter-spacing: -2px; }
        .pao-lbl { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); margin-top: -5px; }
        
        .story-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent);
            line-height: 1.4;
            max-width: 90%;
        }

        .answer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: left; width: 100%; margin-bottom: 20px; }
        .ans-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 3px solid var(--text-dim); }
        .ans-p { border-color: #ff6b6b; } 
        .ans-a { border-color: #feca57; } 
        .ans-o { border-color: #48dbfb; }
        .ans-lbl { font-size: 0.7rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .ans-txt { font-weight: bold; font-size: 1.1rem; line-height: 1.2; }
        
        /* EDITOR LIST */
        .editor-list {
            flex: 1;
            overflow-y: auto;
            text-align: left;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            max-height: 400px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .li-info { display: flex; gap: 15px; align-items: center; }
        .li-num { font-weight: 900; color: var(--accent); font-size: 1.2rem; width: 30px; }
        .li-txt { color: var(--text-dim); font-size: 0.9rem; }
        .li-main { font-weight: bold; color: var(--text-main); }
        .pao-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #333; margin-right: 5px; }
        
        /* FORMS & BUTTONS */
        input {
            width: 100%; padding: 15px; margin-bottom: 15px;
            background: var(--bg); border: 2px solid var(--text-dim);
            border-radius: 8px; color: white; font-size: 1.1rem; box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 15px 30px; border-radius: 8px; font-weight: 900;
            font-size: 1.2rem; cursor: pointer; width: 100%; transition: 0.1s;
        }
        .btn:active { transform: translateY(2px); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-accent { background: var(--accent); color: var(--bg); }
        .btn-small { padding: 5px 15px; font-size: 0.9rem; width: auto; }
        .btn-toggle { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-bottom: 10px; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .hidden { display: none !important; }

        /* CHART */
        .chart-box { width: 100%; height: 150px; background: rgba(0,0,0,0.3); margin-top: auto; border: 1px solid var(--text-dim); position: relative; }
        canvas { width: 100%; height: 100%; }

        /* MODAL */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal { background: var(--surface); padding: 30px; border-radius: 12px; border: 2px solid var(--accent); width: 80%; max-width: 500px; text-align: left; }
        .modal label { display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('trial')">Time Trial</button>
        <button class="nav-btn" onclick="switchTab('reader')">Speed Reader</button>
        <button class="nav-btn" onclick="switchTab('editor')">Card Editor</button>
    </div>

    <div id="tab-trial" class="mode-section active">
        <div id="trial-lobby">
            <h1>TIME TRIAL</h1>
            <p>60 Seconds. +10s Correct. -5s Incorrect.<br>Survive as long as possible.</p>
            <div class="stat-grid">
                <div class="stat-box">Best Score<span class="stat-val" id="trial-best-display">0</span></div>
            </div>
            <button class="btn btn-accent" onclick="startTrial()">START RUN</button>
        </div>

        <div id="trial-game" class="hidden">
            <div class="stat-grid">
                <div class="stat-box">Score<span class="stat-val" id="trial-score">0</span></div>
                <div class="stat-box">Time<span class="stat-val" id="trial-timer">60</span></div>
            </div>

            <div id="trial-input-phase">
                <div class="prompt-card">
                    <div class="big-number" id="trial-prompt">00</div>
                </div>
                <input type="text" id="trial-in-letters" placeholder="Letters (e.g. OO)" autocomplete="off">
                <input type="text" id="trial-in-sentence" placeholder="Sentence..." autocomplete="off">
                <button class="btn" onclick="checkTrialInput()">CHECK</button>
            </div>

            <div id="trial-verify-phase" class="hidden">
                <h2>DID YOU GET IT?</h2>
                <div class="ans-box" style="margin-bottom: 20px;">
                    <span class="ans-lbl">CORRECT ANSWER</span>
                    <div class="ans-txt" id="trial-correct-display"></div>
                </div>
                <div class="ans-box" style="margin-bottom: 20px; border-left-color: var(--text-dim);">
                    <span class="ans-lbl">YOU TYPED</span>
                    <div class="ans-txt" id="trial-user-display" style="font-style: italic; color: #aaa;"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-red" onclick="trialVerdict(false)">WRONG (-5s)</button>
                    <button class="btn btn-green" onclick="trialVerdict(true)">RIGHT (+10s)</button>
                </div>
            </div>
        </div>

        <div id="trial-end" class="hidden">
            <h1 style="color: var(--danger)">TIME UP</h1>
            <p>Final Score</p>
            <div class="big-number" id="trial-final-score" style="margin-bottom: 30px;">0</div>
            <button class="btn" onclick="resetTrialUI()">TRY AGAIN</button>
        </div>
    </div>


   <div id="tab-reader" class="mode-section">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; gap: 10px;">
            <div class="stat-box" style="text-align:left">Avg<br><span class="stat-val" id="reader-avg">0.00s</span></div>
            <div class="stat-box" style="text-align:center">Last<br><span class="stat-val" style="color: var(--neon)" id="reader-last">--</span></div>
            <button class="btn btn-small btn-toggle" style="margin:0; font-size: 0.75rem;" id="btn-reader-mode" onclick="toggleReaderMode()">Mode: Digits → Story</button>
        </div>

        <div id="reader-prompt" class="prompt-card" onclick="revealReader()">
            <div id="rp-digits-view">
                <div class="pao-row">
                    <div class="pao-digit"><div class="pao-num" id="rp-p">00</div><div class="pao-lbl">Person</div></div>
                    <div class="pao-digit"><div class="pao-num" style="color:#555">-</div></div>
                    <div class="pao-digit"><div class="pao-num" id="rp-a">00</div><div class="pao-lbl">Action</div></div>
                    <div class="pao-digit"><div class="pao-num" style="color:#555">-</div></div>
                    <div class="pao-digit"><div class="pao-num" id="rp-o">00</div><div class="pao-lbl">Object</div></div>
                </div>
            </div>
            
            <div id="rp-story-view" class="hidden">
                <div class="story-display" id="rp-story-text">...</div>
            </div>

            <p style="margin: 20px 0 0 0; font-size: 0.8rem; color: var(--text-dim);">Tap Space or Click to Reveal</p>
        </div>

        <div id="reader-answer" class="hidden">
            <div class="answer-grid" id="ra-grid">
                <div class="ans-box ans-p"><span class="ans-lbl">PERSON (from <span id="ral-p">00</span>)</span><div class="ans-txt" id="ra-p">...</div></div>
                <div class="ans-box ans-a"><span class="ans-lbl">ACTION (from <span id="ral-a">00</span>)</span><div class="ans-txt" id="ra-a">...</div></div>
                <div class="ans-box ans-o"><span class="ans-lbl">OBJECT (from <span id="ral-o">00</span>)</span><div class="ans-txt" id="ra-o">...</div></div>
            </div>
            
            <div id="ra-reverse-digits" class="hidden" style="margin-bottom:20px;">
                <div class="pao-row">
                    <div class="pao-digit"><div class="pao-num" id="rar-p" style="font-size:3rem">00</div></div>
                    <div class="pao-digit"><div class="pao-num" id="rar-a" style="font-size:3rem">00</div></div>
                    <div class="pao-digit"><div class="pao-num" id="rar-o" style="font-size:3rem">00</div></div>
                </div>
            </div>

            <div class="full-phrase" id="ra-full">"..."</div>

            <div class="btn-group">
                <button class="btn btn-red" onclick="readerVerdict(false)">FAIL (1)</button>
                <button class="btn btn-green" onclick="readerVerdict(true)">SUCCESS (2)</button>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="speedChart"></canvas>
        </div>
    </div>


    <div id="tab-editor" class="mode-section">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>Card Editor</h2>
            <button class="btn btn-small btn-red" onclick="factoryReset()">Reset All</button>
        </div>
        <div id="editor-list" class="editor-list">
            </div>
    </div>

</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Edit Card <span id="modal-num" style="color:var(--accent)">00</span></h2>
        
        <label>Letters</label>
        <input type="text" id="modal-letters">
        
        <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;">
            <div>
                <label>Person</label>
                <input type="text" id="modal-p">
            </div>
            <div>
                <label>Action</label>
                <input type="text" id="modal-a">
            </div>
            <div>
                <label>Object</label>
                <input type="text" id="modal-o">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-red" onclick="closeModal()">Cancel</button>
            <button class="btn btn-green" onclick="saveModal()">Save</button>
        </div>
    </div>
</div>

<script>
    // --- SPLIT DATA ---
    const RAW_100 = [
        { n:"00", l:"OO", p:"Ozzy Osbourne", a:"screams", o:"heavy metal" },
        { n:"01", l:"OA", p:"Neo (The One)", a:"matrixes", o:"the bullet" },
        { n:"02", l:"OB", p:"Orlando Bloom", a:"boards", o:"the pirate ship" },
        { n:"03", l:"OC", p:"Andits", a:"streams", o:"1010 digits of pi" },
        { n:"04", l:"OD", p:"Odin", a:"births", o:"Thor" },
        { n:"05", l:"OE", p:"Oedipus", a:"sucks", o:"mom's teet" },
        { n:"06", l:"OS", p:"Octavia Spencer", a:"calculates", o:"the launch angle" },
        { n:"07", l:"OG", p:"Olivier Giroud", a:"scores", o:"the penalty kick" },
        { n:"08", l:"OH", p:"Ohio State", a:"loses to", o:"Michigan" },
        { n:"09", l:"ON", p:"Oscar Nunez", a:"annoys", o:"Michael Scott" },
        { n:"10", l:"AO", p:"AOC", a:"plays", o:"Among Us" },
        { n:"11", l:"AA", p:"Ashley Alexander", a:"whisks", o:"nami matcha" },
        { n:"12", l:"AB", p:"Alexander Bell", a:"invents", o:"the telephone" },
        { n:"13", l:"AC", p:"Al Capone", a:"bootlegs", o:"alcohol" },
        { n:"14", l:"AD", p:"Anthony Davis", a:"dunks", o:"the basketball" },
        { n:"15", l:"AE", p:"Albert Einstein", a:"solves", o:"the equation" },
        { n:"16", l:"AS", p:"Arnold Schwarzenegger", a:"lifts", o:"weights" },
        { n:"17", l:"AG", p:"Ariana Grande", a:"makes out with", o:"Ethan Slater" },
        { n:"18", l:"AH", p:"Alexander Hamilton", a:"performs", o:"my shot" },
        { n:"19", l:"AN", p:"Alfred Nobel", a:"awarded", o:"peace prize" },
        { n:"20", l:"BO", p:"Barack Obama", a:"legislates", o:"Obamacare" },
        { n:"21", l:"BA", p:"Buzz Aldrin", a:"lands", o:"the moon" },
        { n:"22", l:"BB", p:"BB8", a:"rolls", o:"in the desert" },
        { n:"23", l:"BC", p:"Bryan Cranston", a:"cooks", o:"crystal meth" },
        { n:"24", l:"BD", p:"Brooklyn Decker", a:"models", o:"sports illustrated swimsuit" },
        { n:"25", l:"BE", p:"Billie Eilish", a:"mumbles", o:"bad guy" },
        { n:"26", l:"BS", p:"Barney Stinson", a:"picks up", o:"women" },
        { n:"27", l:"BG", p:"Britney Griner", a:"gets arrested", o:"in Russia" },
        { n:"28", l:"BH", p:"Brett Hull", a:"skates", o:"on ice rink" },
        { n:"29", l:"BN", p:"Benjamin Netanyahu", a:"commits", o:"genocide in Gaza" },
        { n:"30", l:"CO", p:"Conan O'Brien", a:"hosts", o:"late night show" },
        { n:"31", l:"CA", p:"Clay Aiken", a:"wins", o:"American Idol" },
        { n:"32", l:"CB", p:"Chris Brown", a:"abuses", o:"Rihanna" },
        { n:"33", l:"CC", p:"CC Sabathia", a:"throws", o:"a strike" },
        { n:"34", l:"CD", p:"Claude Debussy", a:"composes", o:"Deux Arabesque" },
        { n:"35", l:"CE", p:"CEO", a:"owns", o:"company" },
        { n:"36", l:"CS", p:"Charlie Sheen", a:"pedophiles", o:"children" },
        { n:"37", l:"CG", p:"Chris Gardner", a:"interviews", o:"at bank" },
        { n:"38", l:"CH", p:"Chris Hemsworth", a:"wields", o:"Mjolnir" },
        { n:"39", l:"CN", p:"Cam Newton", a:"throws", o:"touchdown" },
        { n:"40", l:"DO", p:"Doctor", a:"treats", o:"patient" },
        { n:"41", l:"DA", p:"District Attorney", a:"prosecutes", o:"criminal" },
        { n:"42", l:"DB", p:"Defensive Back", a:"intercepts", o:"football" },
        { n:"43", l:"DC", p:"Dick Cheney", a:"bombs", o:"Iraq" },
        { n:"44", l:"DD", p:"Designated Driver", a:"drives", o:"drunk people home" },
        { n:"45", l:"DE", p:"Dale Earnhardt", a:"races", o:"NASCAR" },
        { n:"46", l:"DS", p:"Dr. Suess", a:"writes", o:"The Cat in the Hat" },
        { n:"47", l:"DG", p:"David Goggins", a:"carries", o:"the boats" },
        { n:"48", l:"DH", p:"DHL", a:"delivers", o:"package" },
        { n:"49", l:"DN", p:"Daniel Negreanu", a:"bluffs", o:"his poker hand" },
        { n:"50", l:"EO", p:"Elmo", a:"snorts", o:"cocaine" },
        { n:"51", l:"EA", p:"EA Sports", a:"announces", o:"it's in the game" },
        { n:"52", l:"EB", p:"Earthbender", a:"bends", o:"rock" },
        { n:"53", l:"EC", p:"Emilia Clarke", a:"burns", o:"the Lannisters" },
        { n:"54", l:"ED", p:"Ellen DeGeneres", a:"bullies", o:"employees" },
        { n:"55", l:"EE", p:"Electrical Engineer", a:"fixes", o:"computers" },
        { n:"56", l:"ES", p:"Edward Snowden", a:"leaks", o:"government secrets" },
        { n:"57", l:"EG", p:"Egg", a:"hatches", o:"into chicken" },
        { n:"58", l:"EH", p:"Evander Holyfield", a:"knocks out", o:"boxer" },
        { n:"59", l:"EN", p:"Elyn Nordegren", a:"gets cheated on by", o:"Tiger Woods" },
        { n:"60", l:"SO", p:"Significant Other", a:"proposes", o:"on one knee" },
        { n:"61", l:"SA", p:"Stephen A. Smith", a:"yaps", o:"on Sportscenter" },
        { n:"62", l:"SB", p:"Sergey Brin", a:"codes", o:"Google" },
        { n:"63", l:"SC", p:"Santa Claus", a:"gifts", o:"Christmas gifts" },
        { n:"64", l:"SD", p:"Snoop Dogg", a:"smokes", o:"weed" },
        { n:"65", l:"SE", p:"Sean Evans", a:"eats", o:"hot wings" },
        { n:"66", l:"SS", p:"Steven Spielberg", a:"directs", o:"ET" },
        { n:"67", l:"SG", p:"Sasha Grey", a:"sucks", o:"dick" },
        { n:"68", l:"SH", p:"Sherlock Holmes", a:"deduces", o:"mystery" },
        { n:"69", l:"SN", p:"Sonic", a:"collects", o:"coins" },
        { n:"70", l:"GO", p:"Goku", a:"powers up to", o:"Super Saiyan 3" },
        { n:"71", l:"GA", p:"Gilbert Arenas", a:"shoots", o:"the gun" },
        { n:"72", l:"GB", p:"George Bush", a:"says", o:"fool me once" },
        { n:"73", l:"GC", p:"GothamChess", a:"checkmates", o:"Magnus Carlsen" },
        { n:"74", l:"GD", p:"Grigor Dimitrov", a:"serves", o:"an ace" },
        { n:"75", l:"GE", p:"Genie", a:"grants", o:"wish" },
        { n:"76", l:"GS", p:"Gwen Stefani", a:"hollers back", o:"at girls" },
        { n:"77", l:"GG", p:"Galileo Galilei", a:"discovers", o:"the stars" },
        { n:"78", l:"GH", p:"Grace Hopper", a:"provides", o:"scholarships" },
        { n:"79", l:"GN", p:"Gavin Newsom", a:"governs", o:"California" },
        { n:"80", l:"HO", p:"Ho-Oh", a:"spams", o:"Sacred Fire" },
        { n:"81", l:"HA", p:"Hans Anderson", a:"tells", o:"fairytales" },
        { n:"82", l:"HB", p:"Hellboy", a:"grinds", o:"horns" },
        { n:"83", l:"HC", p:"House Cat", a:"catches", o:"mice" },
        { n:"84", l:"HD", p:"House Dog", a:"chews", o:"bone" },
        { n:"85", l:"HE", p:"He-Man", a:"kills", o:"Skeletor" },
        { n:"86", l:"HS", p:"Harry Styles", a:"sings", o:"Watermelon Sugar" },
        { n:"87", l:"HG", p:"FlygonHG", a:"plays", o:"Nuzlocke" },
        { n:"88", l:"HH", p:"Hulk Hogan", a:"wrestles", o:"on WWE" },
        { n:"89", l:"HN", p:"Hikaru Nakamura", a:"looks up at", o:"ceiling" },
        { n:"90", l:"NO", p:"Nick Offerman", a:"manages", o:"April" },
        { n:"91", l:"NA", p:"Neil Armstrong", a:"leaps", o:"for mankind" },
        { n:"92", l:"NB", p:"Shohei Ohtani", a:"wears", o:"New Balance" },
        { n:"93", l:"NC", p:"Nicholas Cage", a:"steals", o:"Declaration of Independence" },
        { n:"94", l:"ND", p:"Nick Digiovanni", a:"films", o:"YouTube Shorts" },
        { n:"95", l:"NE", p:"Nemo", a:"swims", o:"forever" },
        { n:"96", l:"NS", p:"Nimbus", a:"flies", o:"to the Golden Snitch" },
        { n:"97", l:"NG", p:"Nice Guy", a:"finishes", o:"last" },
        { n:"98", l:"NH", p:"Naruto Hokage", a:"leads", o:"Leaf Village" },
        { n:"99", l:"NN", p:"Ninja", a:"falls off", o:"on Twitch" }
    ];

    let DATA = [];
    let isReaderReverse = false;

    // --- UTILS ---
    const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, "");
    
    // --- SOUNDS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'good') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('pao-data-v4');
        DATA = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(RAW_100));

        // Load Best Scores
        document.getElementById('trial-best-display').textContent = localStorage.getItem('pao-trial-best') || 0;
        
        renderEditor();
        switchTab('trial');
    }

    function saveData() {
        localStorage.setItem('pao-data-v4', JSON.stringify(DATA));
    }

    function factoryReset() {
        if(confirm("Reset everything to default?")) {
            localStorage.removeItem('pao-data-v4');
            init();
            renderEditor();
        }
    }

    // --- NAVIGATION ---
    function switchTab(tab) {
        document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tab === 'reader') startReader();
        if (tab === 'trial') resetTrialUI();
    }

    // --- EDITOR ---
    function renderEditor() {
        const list = document.getElementById('editor-list');
        list.innerHTML = '';
        DATA.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="li-info">
                    <span class="li-num">${item.n}</span>
                    <div style="text-align:left">
                        <div class="li-main">${item.l}</div>
                        <div class="li-txt">
                            <span class="pao-tag">P</span>${item.p} <br>
                            <span class="pao-tag">A</span>${item.a} <br>
                            <span class="pao-tag">O</span>${item.o}
                        </div>
                    </div>
                </div>
                <button class="btn btn-small btn-accent" onclick="openEdit(${idx})">Edit</button>
            `;
            list.appendChild(div);
        });
    }

    let editingIndex = -1;
    function openEdit(idx) {
        editingIndex = idx;
        const item = DATA[idx];
        document.getElementById('modal-num').textContent = item.n;
        document.getElementById('modal-letters').value = item.l;
        document.getElementById('modal-p').value = item.p;
        document.getElementById('modal-a').value = item.a;
        document.getElementById('modal-o').value = item.o;
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function saveModal() {
        if (editingIndex > -1) {
            DATA[editingIndex].l = document.getElementById('modal-letters').value;
            DATA[editingIndex].p = document.getElementById('modal-p').value;
            DATA[editingIndex].a = document.getElementById('modal-a').value;
            DATA[editingIndex].o = document.getElementById('modal-o').value;
            saveData();
            renderEditor();
            closeModal();
        }
    }

    function closeModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    // --- TIME TRIAL ---
    let trialScore = 0;
    let trialTime = 60;
    let trialInterval = null;
    let trialCurrent = null;
    let trialPool = [];

    function resetTrialUI() {
        document.getElementById('trial-lobby').classList.remove('hidden');
        document.getElementById('trial-game').classList.add('hidden');
        document.getElementById('trial-end').classList.add('hidden');
    }

    function startTrial() {
        trialScore = 0;
        trialTime = 60;
        trialPool = [...DATA];
        
        document.getElementById('trial-lobby').classList.add('hidden');
        document.getElementById('trial-end').classList.add('hidden');
        document.getElementById('trial-game').classList.remove('hidden');
        
        document.getElementById('trial-score').textContent = '0';
        updateTrialTimer();
        
        pickTrialCard();
        
        if (trialInterval) clearInterval(trialInterval);
        trialInterval = setInterval(() => {
            trialTime--;
            updateTrialTimer();
            if (trialTime <= 0) endTrial();
        }, 1000);
    }

    function updateTrialTimer() {
        const el = document.getElementById('trial-timer');
        el.textContent = trialTime;
        if (trialTime <= 10) el.classList.add('timer-danger');
        else el.classList.remove('timer-danger');
    }

    function pickTrialCard() {
        if (trialPool.length === 0) trialPool = [...DATA];
        const r = Math.floor(Math.random() * trialPool.length);
        trialCurrent = trialPool[r];
        trialPool.splice(r, 1);

        document.getElementById('trial-input-phase').classList.remove('hidden');
        document.getElementById('trial-verify-phase').classList.add('hidden');
        
        document.getElementById('trial-prompt').textContent = trialCurrent.n;
        document.getElementById('trial-in-letters').value = '';
        document.getElementById('trial-in-sentence').value = '';
        document.getElementById('trial-in-letters').focus();
    }

    function checkTrialInput() {
        const userLet = normalize(document.getElementById('trial-in-letters').value);
        const correctLet = normalize(trialCurrent.l);
        const userSent = document.getElementById('trial-in-sentence').value;

        // Auto-fail letters
        if (userLet !== correctLet) {
            playSound('bad');
            trialTime = Math.max(0, trialTime - 5);
            updateTrialTimer();
            pickTrialCard(); 
            return;
        }

        // Verify Sentence
        document.getElementById('trial-input-phase').classList.add('hidden');
        document.getElementById('trial-verify-phase').classList.remove('hidden');
        document.getElementById('trial-correct-display').innerHTML = `<strong>${trialCurrent.l}</strong> - ${trialCurrent.p} ${trialCurrent.a} ${trialCurrent.o}`;
        document.getElementById('trial-user-display').textContent = userSent;
        document.activeElement.blur();
    }

    function trialVerdict(good) {
        if (good) {
            playSound('good');
            trialScore++;
            trialTime += 10;
        } else {
            playSound('bad');
            trialTime = Math.max(0, trialTime - 5);
        }
        document.getElementById('trial-score').textContent = trialScore;
        updateTrialTimer();
        pickTrialCard();
    }

    function endTrial() {
        clearInterval(trialInterval);
        document.getElementById('trial-game').classList.add('hidden');
        document.getElementById('trial-end').classList.remove('hidden');
        document.getElementById('trial-final-score').textContent = trialScore;
        
        const best = parseInt(localStorage.getItem('pao-trial-best') || '0');
        if (trialScore > best) {
            localStorage.setItem('pao-trial-best', trialScore);
            document.getElementById('trial-best-display').textContent = trialScore;
        }
    }

    // --- SPEED READER ---
    let readerCurrent = { p:null, a:null, o:null };
    let readerStart = 0;
    let readerHistory = [];

    function startReader() {
        pickReaderCard();
    }
    
    function toggleReaderMode() {
        isReaderReverse = !isReaderReverse;
        const btn = document.getElementById('btn-reader-mode');
        btn.textContent = isReaderReverse ? "Mode: Story → Digits" : "Mode: Digits → Story";
        
        // Reset current flow
        document.getElementById('reader-answer').classList.add('hidden');
        document.getElementById('reader-prompt').classList.remove('hidden');
        
        pickReaderCard();
    }

    function pickReaderCard() {
        const r1 = Math.floor(Math.random() * DATA.length);
        const r2 = Math.floor(Math.random() * DATA.length);
        const r3 = Math.floor(Math.random() * DATA.length);

        readerCurrent.p = DATA[r1];
        readerCurrent.a = DATA[r2];
        readerCurrent.o = DATA[r3];

        // SETUP PROMPT
        if (!isReaderReverse) {
            // DIGITS -> STORY
            document.getElementById('rp-digits-view').classList.remove('hidden');
            document.getElementById('rp-story-view').classList.add('hidden');
            
            document.getElementById('rp-p').textContent = readerCurrent.p.n;
            document.getElementById('rp-a').textContent = readerCurrent.a.n;
            document.getElementById('rp-o').textContent = readerCurrent.o.n;
        } else {
            // STORY -> DIGITS
            document.getElementById('rp-digits-view').classList.add('hidden');
            document.getElementById('rp-story-view').classList.remove('hidden');
            
            document.getElementById('rp-story-text').textContent = 
                `${readerCurrent.p.p} ... ${readerCurrent.a.a} ... ${readerCurrent.o.o}`;
        }

        // SETUP ANSWER
        document.getElementById('ral-p').textContent = readerCurrent.p.n;
        document.getElementById('ra-p').textContent = readerCurrent.p.p;
        document.getElementById('ral-a').textContent = readerCurrent.a.n;
        document.getElementById('ra-a').textContent = readerCurrent.a.a;
        document.getElementById('ral-o').textContent = readerCurrent.o.n;
        document.getElementById('ra-o').textContent = readerCurrent.o.o;
        
        document.getElementById('ra-full').textContent = `${readerCurrent.p.p} ${readerCurrent.a.a} ${readerCurrent.o.o}`;
        
        // REVERSE ANSWER SETUP (Digits)
        document.getElementById('rar-p').textContent = readerCurrent.p.n;
        document.getElementById('rar-a').textContent = readerCurrent.a.n;
        document.getElementById('rar-o').textContent = readerCurrent.o.n;

        document.getElementById('reader-prompt').classList.remove('hidden');
        document.getElementById('reader-answer').classList.add('hidden');
        
        readerStart = Date.now();
    }

    function revealReader() {
        if (document.getElementById('reader-prompt').classList.contains('hidden')) return;
        
        const diff = (Date.now() - readerStart) / 1000;
        document.getElementById('reader-last').textContent = diff.toFixed(2) + 's';
        
        document.getElementById('reader-prompt').classList.add('hidden');
        document.getElementById('reader-answer').classList.remove('hidden');
        
        // Show/Hide relevant answer blocks
        if (!isReaderReverse) {
            document.getElementById('ra-grid').classList.remove('hidden');
            document.getElementById('ra-reverse-digits').classList.add('hidden');
        } else {
            document.getElementById('ra-grid').classList.add('hidden');
            document.getElementById('ra-reverse-digits').classList.remove('hidden');
        }
        
        readerCurrent.time = diff;
    }

    function readerVerdict(good) {
        if (good) {
            playSound('good');
            readerHistory.push(readerCurrent.time);
            if (readerHistory.length > 20) readerHistory.shift();
            const avg = readerHistory.reduce((a,b)=>a+b,0) / readerHistory.length;
            document.getElementById('reader-avg').textContent = avg.toFixed(2) + 's';
            drawChart();
        } else {
            playSound('bad');
        }
        pickReaderCard();
    }

    // --- CHART ---
    function drawChart() {
        const c = document.getElementById('speedChart');
        const ctx = c.getContext('2d');
        c.width = c.clientWidth; c.height = c.clientHeight;
        const w = c.width; const h = c.height;

        ctx.clearRect(0,0,w,h);
        if (readerHistory.length < 2) return;

        ctx.beginPath();
        ctx.strokeStyle = '#00f3ff';
        ctx.lineWidth = 2;

        const max = Math.max(...readerHistory, 3);
        const step = w / (readerHistory.length - 1);

        readerHistory.forEach((val, i) => {
            const x = i * step;
            const y = h - ((val / max) * (h - 20)) - 10;
            if (i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }

    // KEYBOARD
    document.addEventListener('keydown', (e) => {
        // Time Trial
        if (document.getElementById('tab-trial').classList.contains('active')) {
            if (e.key === 'Enter' && !document.getElementById('trial-input-phase').classList.contains('hidden')) checkTrialInput();
            if (!document.getElementById('trial-verify-phase').classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') trialVerdict(false);
                if (e.key === 'ArrowRight') trialVerdict(true);
            }
        }
        // Reader
        if (document.getElementById('tab-reader').classList.contains('active')) {
            if (!document.getElementById('reader-prompt').classList.contains('hidden')) {
                if (e.code === 'Space') revealReader();
            } else {
                if (e.key === '1') readerVerdict(false);
                if (e.key === '2' || e.code === 'Space') readerVerdict(true);
            }
        }
    });

    // Boot
    init();

</script>
</body>
</html>
