<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAO Master Suite</title>
    <style>
        :root {
            --bg: #121212;
            --surface: #2a2e35;
            --primary: #4682b4;
            --accent: #ffd700;
            --text-main: #e0e0e0;
            --text-dim: #6c757d;
            --success: #2e7d32;
            --danger: #c62828;
            --neon: #00f3ff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
        }

        .app-container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            width: 95%;
            max-width: 800px;
            min-height: 600px;
            text-align: center;
            border: 1px solid var(--text-dim);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* NAVIGATION */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--text-dim);
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .nav-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 15px rgba(70, 130, 180, 0.4); }

        /* SECTIONS */
        .mode-section { display: none; flex-direction: column; height: 100%; flex: 1; }
        .mode-section.active { display: flex; }

        /* COMMON COMPONENTS */
        h1 { color: var(--accent); margin: 0 0 10px 0; font-size: 2.5rem; }
        p { color: var(--text-dim); margin-bottom: 20px; }

        .stat-grid { display: flex; justify-content: space-around; margin-bottom: 20px; width: 100%; }
        .stat-box { font-size: 0.8rem; text-transform: uppercase; color: var(--text-dim); }
        .stat-val { font-size: 1.5rem; font-weight: 900; color: var(--text-main); display: block; }
        
        .timer-huge { font-family: monospace; font-size: 4rem; font-weight: bold; color: white; margin: 10px 0; }
        .timer-danger { color: var(--danger); animation: pulse 0.5s infinite; }

        /* CARDS */
        .prompt-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        
        .big-number { font-size: 5rem; font-weight: 900; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        /* SPEED READER SPECIFIC */
        .pao-row { display: flex; gap: 15px; justify-content: center; width: 100%; }
        .pao-digit { text-align: center; }
        .pao-num { font-size: 3.5rem; font-weight: 900; font-family: monospace; color: white; }
        .pao-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); }
        
        .answer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: left; width: 100%; margin-bottom: 20px; }
        .ans-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 3px solid var(--text-dim); }
        .ans-p { border-color: #ff6b6b; } 
        .ans-a { border-color: #feca57; } 
        .ans-o { border-color: #48dbfb; }
        .ans-lbl { font-size: 0.7rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .ans-txt { font-weight: bold; font-size: 1.1rem; line-height: 1.2; }
        .full-phrase { grid-column: span 3; text-align: center; font-size: 1.2rem; color: var(--accent); font-style: italic; margin-top: 10px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 6px;}

        /* EDITOR LIST */
        .editor-list {
            flex: 1;
            overflow-y: auto;
            text-align: left;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            max-height: 400px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .li-info { display: flex; gap: 15px; align-items: center; }
        .li-num { font-weight: 900; color: var(--accent); font-size: 1.2rem; width: 30px; }
        .li-txt { color: var(--text-dim); font-size: 0.9rem; }
        .li-main { font-weight: bold; color: var(--text-main); }
        
        /* FORMS & BUTTONS */
        input {
            width: 100%; padding: 15px; margin-bottom: 15px;
            background: var(--bg); border: 2px solid var(--text-dim);
            border-radius: 8px; color: white; font-size: 1.1rem; box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 15px 30px; border-radius: 8px; font-weight: 900;
            font-size: 1.2rem; cursor: pointer; width: 100%; transition: 0.1s;
        }
        .btn:active { transform: translateY(2px); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-accent { background: var(--accent); color: var(--bg); }
        .btn-small { padding: 5px 15px; font-size: 0.9rem; width: auto; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .hidden { display: none !important; }

        /* CHART */
        .chart-box { width: 100%; height: 150px; background: rgba(0,0,0,0.3); margin-top: auto; border: 1px solid var(--text-dim); position: relative; }
        canvas { width: 100%; height: 100%; }

        /* MODAL */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal { background: var(--surface); padding: 30px; border-radius: 12px; border: 2px solid var(--accent); width: 80%; max-width: 400px; text-align: left; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('trial')">Time Trial</button>
        <button class="nav-btn" onclick="switchTab('reader')">Speed Reader</button>
        <button class="nav-btn" onclick="switchTab('editor')">Card Editor</button>
    </div>

    <div id="tab-trial" class="mode-section active">
        <div id="trial-lobby">
            <h1>TIME TRIAL</h1>
            <p>60 Seconds. +10s Correct. -5s Incorrect.<br>Survive as long as possible.</p>
            <div class="stat-grid">
                <div class="stat-box">Best Score<span class="stat-val" id="trial-best-display">0</span></div>
            </div>
            <button class="btn btn-accent" onclick="startTrial()">START RUN</button>
        </div>

        <div id="trial-game" class="hidden">
            <div class="stat-grid">
                <div class="stat-box">Score<span class="stat-val" id="trial-score">0</span></div>
                <div class="stat-box">Time<span class="stat-val" id="trial-timer">60</span></div>
            </div>

            <div id="trial-input-phase">
                <div class="prompt-card">
                    <div class="big-number" id="trial-prompt">00</div>
                </div>
                <input type="text" id="trial-in-letters" placeholder="Letters (e.g. OO)" autocomplete="off">
                <input type="text" id="trial-in-sentence" placeholder="Sentence..." autocomplete="off">
                <button class="btn" onclick="checkTrialInput()">CHECK</button>
            </div>

            <div id="trial-verify-phase" class="hidden">
                <h2>DID YOU GET IT?</h2>
                <div class="ans-box" style="margin-bottom: 20px;">
                    <span class="ans-lbl">CORRECT ANSWER</span>
                    <div class="ans-txt" id="trial-correct-display"></div>
                </div>
                <div class="ans-box" style="margin-bottom: 20px; border-left-color: var(--text-dim);">
                    <span class="ans-lbl">YOU TYPED</span>
                    <div class="ans-txt" id="trial-user-display" style="font-style: italic; color: #aaa;"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-red" onclick="trialVerdict(false)">WRONG (-5s)</button>
                    <button class="btn btn-green" onclick="trialVerdict(true)">RIGHT (+10s)</button>
                </div>
            </div>
        </div>

        <div id="trial-end" class="hidden">
            <h1 style="color: var(--danger)">TIME UP</h1>
            <p>Final Score</p>
            <div class="big-number" id="trial-final-score" style="margin-bottom: 30px;">0</div>
            <button class="btn" onclick="resetTrialUI()">TRY AGAIN</button>
        </div>
    </div>


    <div id="tab-reader" class="mode-section">
        <div class="stat-grid">
            <div class="stat-box">Avg Speed<span class="stat-val" id="reader-avg">0.00s</span></div>
            <div class="stat-box">Last<span class="stat-val" style="color: var(--neon)" id="reader-last">--</span></div>
        </div>

        <div id="reader-prompt" class="prompt-card" style="cursor: pointer; gap:20px;" onclick="revealReader()">
            <div class="pao-row">
                <div class="pao-digit"><div class="pao-num" id="rp-p">00</div><div class="pao-lbl">Person</div></div>
                <div class="pao-digit"><div class="pao-num" style="color:#555">-</div></div>
                <div class="pao-digit"><div class="pao-num" id="rp-a">00</div><div class="pao-lbl">Action</div></div>
                <div class="pao-digit"><div class="pao-num" style="color:#555">-</div></div>
                <div class="pao-digit"><div class="pao-num" id="rp-o">00</div><div class="pao-lbl">Object</div></div>
            </div>
            <p style="margin: 20px 0 0 0; font-size: 0.8rem;">Tap / Space to Reveal</p>
        </div>

        <div id="reader-answer" class="hidden">
            <div class="answer-grid">
                <div class="ans-box ans-p"><span class="ans-lbl">PERSON</span><div class="ans-txt" id="ra-p">...</div></div>
                <div class="ans-box ans-a"><span class="ans-lbl">ACTION</span><div class="ans-txt" id="ra-a">...</div></div>
                <div class="ans-box ans-o"><span class="ans-lbl">OBJECT</span><div class="ans-txt" id="ra-o">...</div></div>
                <div class="full-phrase" id="ra-full">"..."</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-red" onclick="readerVerdict(false)">FAIL (1)</button>
                <button class="btn btn-green" onclick="readerVerdict(true)">SUCCESS (2)</button>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="speedChart"></canvas>
        </div>
    </div>


    <div id="tab-editor" class="mode-section">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>Card Editor</h2>
            <button class="btn btn-small btn-red" onclick="factoryReset()">Reset All</button>
        </div>
        <div id="editor-list" class="editor-list">
            </div>
    </div>

</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Edit Card <span id="modal-num" style="color:var(--accent)">00</span></h2>
        <label>Letters</label>
        <input type="text" id="modal-letters">
        <label>Sentence</label>
        <input type="text" id="modal-sentence">
        <div class="btn-group">
            <button class="btn btn-red" onclick="closeModal()">Cancel</button>
            <button class="btn btn-green" onclick="saveModal()">Save</button>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    const DEFAULT_DATA = [
        { num: "00", let: "OO", sent: "Ozzy Osbourne screams heavy metal" },
        { num: "01", let: "OA", sent: "Neo (The One) matrixes the bullet" },
        { num: "02", let: "OB", sent: "Orlando Bloom boards the pirate ship" },
        { num: "03", let: "OC", sent: "andits rues treams 1010 digits of pi" },
        { num: "04", let: "OD", sent: "Odin births Thor" },
        { num: "05", let: "OE", sent: "Oedipus sucks mom's teet" },
        { num: "06", let: "OS", sent: "Octavia Spencer calculates the launch angle" },
        { num: "07", let: "OG", sent: "Olivier Giroud scores the penalty kick" },
        { num: "08", let: "OH", sent: "Ohio State loses to michigan" },
        { num: "09", let: "ON", sent: "Oscar Nunez annoys michael scott" },
        { num: "10", let: "AO", sent: "AOC plays among us" },
        { num: "11", let: "AA", sent: "Ashley Alexander whisks nami matcha" },
        { num: "12", let: "AB", sent: "Alexander Bell invents the telephone" },
        { num: "13", let: "AC", sent: "Al Capone bootlegs alcohol" },
        { num: "14", let: "AD", sent: "Anthony Davis dunks the basketball" },
        { num: "15", let: "AE", sent: "Albert Einstein solves the equation" },
        { num: "16", let: "AS", sent: "Arnold Schwartzenager lifts weights" },
        { num: "17", let: "AG", sent: "Ariana Grande makes out with Ethan Slater" },
        { num: "18", let: "AH", sent: "Alexander Hamilton performs my shot" },
        { num: "19", let: "AN", sent: "Alfred Nobel awarded peace prize" },
        { num: "20", let: "BO", sent: "barack obama legislates obamacare" },
        { num: "21", let: "BA", sent: "buzz aldrin lands the moon" },
        { num: "22", let: "BB", sent: "bb8 rolls in the desert" },
        { num: "23", let: "BC", sent: "bryan cranston cooks crystal meth" },
        { num: "24", let: "BD", sent: "brooklyn decker models sports illustrated swimsuit" },
        { num: "25", let: "BE", sent: "Billie Eilish mumbles bad guy" },
        { num: "26", let: "BS", sent: "Barney stinson picks up women" },
        { num: "27", let: "BG", sent: "Britney Griner gets arrested in russia" },
        { num: "28", let: "BH", sent: "Brett Hull skates on ice rink" },
        { num: "29", let: "BN", sent: "Benjamin Netanyahu commits genocide in gaza" },
        { num: "30", let: "CO", sent: "Conan O'Brien hosts late night hosw" },
        { num: "31", let: "CA", sent: "Clay Aiken wins american idol" },
        { num: "32", let: "CB", sent: "chris brown abuses rihanna" },
        { num: "33", let: "CC", sent: "CC Sabathia throws a strike" },
        { num: "34", let: "CD", sent: "Claude Debussy composes deux arabesque" },
        { num: "35", let: "CE", sent: "CEO owns company" },
        { num: "36", let: "CS", sent: "charlie sheen pedophiles children" },
        { num: "37", let: "CG", sent: "Chris gardner interviews at bank" },
        { num: "38", let: "CH", sent: "chris hemsworth wields mjolnir" },
        { num: "39", let: "CN", sent: "Cam newton throws touchdown" },
        { num: "40", let: "DO", sent: "doctor treats patient" },
        { num: "41", let: "DA", sent: "district attorney prosecutes criminal" },
        { num: "42", let: "DB", sent: "defensive back intercepts football" },
        { num: "43", let: "DC", sent: "Dick cheney bombs iraq" },
        { num: "44", let: "DD", sent: "designated driver drives drunk people home" },
        { num: "45", let: "DE", sent: "Dale Earnhardt races nascar" },
        { num: "46", let: "DS", sent: "Dr. Suess writes the cat in the hat" },
        { num: "47", let: "DG", sent: "David Goggins carries the boats" },
        { num: "48", let: "DH", sent: "DHL delivers package" },
        { num: "49", let: "DN", sent: "Daniel Negraneu bluffs his poker hand" },
        { num: "50", let: "EO", sent: "Elmo snorts cocaine" },
        { num: "51", let: "EA", sent: "EA Sports announces it's in the game" },
        { num: "52", let: "EB", sent: "Earthbender bends rock" },
        { num: "53", let: "EC", sent: "Emilia clarke burns the lannisters" },
        { num: "54", let: "ED", sent: "Ellen Degeneres bullies employees" },
        { num: "55", let: "EE", sent: "Electrical Engineer fixes computers" },
        { num: "56", let: "ES", sent: "Edward Snowden leaks government secrets" },
        { num: "57", let: "EG", sent: "egg hatches into chicken" },
        { num: "58", let: "EH", sent: "Evander holyfield knocks out boxer" },
        { num: "59", let: "EN", sent: "Elyn Nordegren gets cheated on by tiger woods" },
        { num: "60", let: "SO", sent: "Significant Other proposes on one knee" },
        { num: "61", let: "SA", sent: "Stephen A. Smith yaps on sportscenter" },
        { num: "62", let: "SB", sent: "Sergey Brin codes google" },
        { num: "63", let: "SC", sent: "Santa Claus gifts christmas gifts" },
        { num: "64", let: "SD", sent: "Snoop dogg smokes weed" },
        { num: "65", let: "SE", sent: "Sean Evans eats hot wings" },
        { num: "66", let: "SS", sent: "Steven Spielberg directs ET" },
        { num: "67", let: "SG", sent: "Sasha Grey sucks dick" },
        { num: "68", let: "SH", sent: "Sherlock Holmes deduces mystery" },
        { num: "69", let: "SN", sent: "Sonic collects coins" },
        { num: "70", let: "GO", sent: "goku powers up to super saiyan 3" },
        { num: "71", let: "GA", sent: "Gilbert Arenas shoots the gun" },
        { num: "72", let: "GB", sent: "george bush says fool me once" },
        { num: "73", let: "GC", sent: "gothamchess checkmates magnus carlsen" },
        { num: "74", let: "GD", sent: "grigor dimitrov serves an ace" },
        { num: "75", let: "GE", sent: "genie grants wish" },
        { num: "76", let: "GS", sent: "Gwen Stefani hollers back at girls" },
        { num: "77", let: "GG", sent: "Galileo Galilei discovers the stars" },
        { num: "78", let: "GH", sent: "Grace Hopper provides scholarships" },
        { num: "79", let: "GN", sent: "Gavin Newsom governs california" },
        { num: "80", let: "HO", sent: "Ho-Oh spams sacred fire" },
        { num: "81", let: "HA", sent: "Hans Anderson tells fairytales" },
        { num: "82", let: "HB", sent: "hellboy grinds horns" },
        { num: "83", let: "HC", sent: "house cat catches mice" },
        { num: "84", let: "HD", sent: "house dog chews bone" },
        { num: "85", let: "HE", sent: "he-man kills skeletor" },
        { num: "86", let: "HS", sent: "Harry styles sings watermelon sugar" },
        { num: "87", let: "HG", sent: "flygonHG plays nuzlocke" },
        { num: "88", let: "HH", sent: "Hulk Hogan wrestles on WWE" },
        { num: "89", let: "HN", sent: "Hikaru Nakamura looks up at ceiling" },
        { num: "90", let: "NO", sent: "nick offerman manages April" },
        { num: "91", let: "NA", sent: "Neil Armstrong leaps for mankind" },
        { num: "92", let: "NB", sent: "Shohei Ohtani wears New Balance" },
        { num: "93", let: "NC", sent: "Nicholas Cage steals Declaration of Independence" },
        { num: "94", let: "ND", sent: "Nick Digiovanni films youtube shorts" },
        { num: "95", let: "NE", sent: "Nemo swims forever" },
        { num: "96", let: "NS", sent: "nimbus flies to the golden snitch" },
        { num: "97", let: "NG", sent: "nice guy finishes last" },
        { num: "98", let: "NH", sent: "Naruto Hokage leads leaf village" },
        { num: "99", let: "NN", sent: "Ninja falls off on twitch" }
    ];

    let DATA = [];
    let PAO_SPLIT = [];

    // --- UTILS ---
    const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, "");
    
    // --- SOUNDS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'good') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('pao-data-v1');
        DATA = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DATA));
        rebuildSplitData();

        // Load Best Scores
        document.getElementById('trial-best-display').textContent = localStorage.getItem('pao-trial-best') || 0;
        
        renderEditor();
        switchTab('trial');
    }

    function rebuildSplitData() {
        PAO_SPLIT = DATA.map(item => {
            // Very naive split logic (User likely needs to manually tune sentences in editor if this fails)
            // But we can try to guess or just use the full sentence for display
            // For this specific Speed Reader requirement, we just need P, A, O to come from different cards?
            // Actually the requirement said: "598903 is Elyn Nordegren looks up at 1010 digits of pi"
            // This implies we need to split the sentences.
            // Since automatic splitting of "Ozzy Osbourne screams heavy metal" is hard without NLP, 
            // I will implement a helper that assumes: 
            // [Person] [Action] [Object]. 
            // Since we can't perfectly split, I will map the Whole Sentence to the P/A/O slots 
            // and rely on the user to edit them into fragments if they want perfect "Action only" display.
            // HOWEVER, based on the default list provided, I can try to split by known structure for the default list?
            // No, too risky. I will just store the full sentence and the user mentally extracts.
            // WAIT! The previous prompt showed a manual split JSON. I will use a simple regex heuristic for now.
            // Or better: The Editor allows editing the sentence.
            // Let's stick to: The "Action" card displays the full sentence of that number, highlighted? 
            // No, for Speed Reader we need clean text. 
            // I will use a placeholder splitter: First 2 words = Person, Middle = Action, Last = Object?
            // Let's use the provided logic from the previous turn which had explicit P/A/O fields.
            // Since the user provided a simple list "Person Action Object", I will assume we can't perfectly split automatically.
            // I will use a generic object: {n, p: item.sent, a: item.sent, o: item.sent} 
            // But actually, for the Speed Reader to look good, I'll try to split by ' ' 
            // This is imperfect but functional for a v1.
            
            const words = item.sent.split(' ');
            let p, a, o;
            if (words.length >= 3) {
                p = words[0] + " " + words[1];
                a = words[2];
                o = words.slice(3).join(" ");
            } else {
                p = item.sent; a = "..."; o = "...";
            }
            return { n: item.num, p: p, a: a, o: o, raw: item };
        });
    }

    function saveData() {
        localStorage.setItem('pao-data-v1', JSON.stringify(DATA));
        rebuildSplitData();
    }

    function factoryReset() {
        if(confirm("Reset everything to default?")) {
            localStorage.removeItem('pao-data-v1');
            init();
            renderEditor();
        }
    }

    // --- NAVIGATION ---
    function switchTab(tab) {
        document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tab === 'reader') startReader();
        if (tab === 'trial') resetTrialUI();
    }

    // --- EDITOR ---
    function renderEditor() {
        const list = document.getElementById('editor-list');
        list.innerHTML = '';
        DATA.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="li-info">
                    <span class="li-num">${item.num}</span>
                    <div style="text-align:left">
                        <div class="li-main">${item.let}</div>
                        <div class="li-txt">${item.sent}</div>
                    </div>
                </div>
                <button class="btn btn-small btn-accent" onclick="openEdit(${idx})">Edit</button>
            `;
            list.appendChild(div);
        });
    }

    let editingIndex = -1;
    function openEdit(idx) {
        editingIndex = idx;
        const item = DATA[idx];
        document.getElementById('modal-num').textContent = item.num;
        document.getElementById('modal-letters').value = item.let;
        document.getElementById('modal-sentence').value = item.sent;
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function saveModal() {
        if (editingIndex > -1) {
            DATA[editingIndex].let = document.getElementById('modal-letters').value;
            DATA[editingIndex].sent = document.getElementById('modal-sentence').value;
            saveData();
            renderEditor();
            closeModal();
        }
    }

    function closeModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    // --- TIME TRIAL ---
    let trialScore = 0;
    let trialTime = 60;
    let trialInterval = null;
    let trialCurrent = null;
    let trialPool = [];

    function resetTrialUI() {
        document.getElementById('trial-lobby').classList.remove('hidden');
        document.getElementById('trial-game').classList.add('hidden');
        document.getElementById('trial-end').classList.add('hidden');
    }

    function startTrial() {
        trialScore = 0;
        trialTime = 60;
        trialPool = [...DATA];
        
        document.getElementById('trial-lobby').classList.add('hidden');
        document.getElementById('trial-end').classList.add('hidden');
        document.getElementById('trial-game').classList.remove('hidden');
        
        document.getElementById('trial-score').textContent = '0';
        updateTrialTimer();
        
        pickTrialCard();
        
        if (trialInterval) clearInterval(trialInterval);
        trialInterval = setInterval(() => {
            trialTime--;
            updateTrialTimer();
            if (trialTime <= 0) endTrial();
        }, 1000);
    }

    function updateTrialTimer() {
        const el = document.getElementById('trial-timer');
        el.textContent = trialTime;
        if (trialTime <= 10) el.classList.add('timer-danger');
        else el.classList.remove('timer-danger');
    }

    function pickTrialCard() {
        if (trialPool.length === 0) trialPool = [...DATA];
        const r = Math.floor(Math.random() * trialPool.length);
        trialCurrent = trialPool[r];
        trialPool.splice(r, 1);

        document.getElementById('trial-input-phase').classList.remove('hidden');
        document.getElementById('trial-verify-phase').classList.add('hidden');
        
        document.getElementById('trial-prompt').textContent = trialCurrent.num;
        document.getElementById('trial-in-letters').value = '';
        document.getElementById('trial-in-sentence').value = '';
        document.getElementById('trial-in-letters').focus();
    }

    function checkTrialInput() {
        const userLet = normalize(document.getElementById('trial-in-letters').value);
        const correctLet = normalize(trialCurrent.let);
        const userSent = document.getElementById('trial-in-sentence').value;

        // Auto-fail letters
        if (userLet !== correctLet) {
            playSound('bad');
            trialTime = Math.max(0, trialTime - 5);
            updateTrialTimer();
            pickTrialCard(); // Skip directly on letter fail for speed
            return;
        }

        // Verify Sentence
        document.getElementById('trial-input-phase').classList.add('hidden');
        document.getElementById('trial-verify-phase').classList.remove('hidden');
        document.getElementById('trial-correct-display').innerHTML = `<strong>${trialCurrent.let}</strong> - ${trialCurrent.sent}`;
        document.getElementById('trial-user-display').textContent = userSent;
        document.activeElement.blur();
    }

    function trialVerdict(good) {
        if (good) {
            playSound('good');
            trialScore++;
            trialTime += 10;
        } else {
            playSound('bad');
            trialTime = Math.max(0, trialTime - 5);
        }
        document.getElementById('trial-score').textContent = trialScore;
        updateTrialTimer();
        pickTrialCard();
    }

    function endTrial() {
        clearInterval(trialInterval);
        document.getElementById('trial-game').classList.add('hidden');
        document.getElementById('trial-end').classList.remove('hidden');
        document.getElementById('trial-final-score').textContent = trialScore;
        
        const best = parseInt(localStorage.getItem('pao-trial-best') || '0');
        if (trialScore > best) {
            localStorage.setItem('pao-trial-best', trialScore);
            document.getElementById('trial-best-display').textContent = trialScore;
        }
    }

    // --- SPEED READER ---
    let readerCurrent = { p:null, a:null, o:null };
    let readerStart = 0;
    let readerHistory = [];

    function startReader() {
        pickReaderCard();
    }

    function pickReaderCard() {
        const r1 = Math.floor(Math.random() * PAO_SPLIT.length);
        const r2 = Math.floor(Math.random() * PAO_SPLIT.length);
        const r3 = Math.floor(Math.random() * PAO_SPLIT.length);

        readerCurrent.p = PAO_SPLIT[r1];
        readerCurrent.a = PAO_SPLIT[r2];
        readerCurrent.o = PAO_SPLIT[r3];

        // Prompt
        document.getElementById('rp-p').textContent = readerCurrent.p.n;
        document.getElementById('rp-a').textContent = readerCurrent.a.n;
        document.getElementById('rp-o').textContent = readerCurrent.o.n;

        // Answer
        document.getElementById('ra-p').textContent = readerCurrent.p.raw.sent; // Using full sentence for context as fallback
        document.getElementById('ra-a').textContent = readerCurrent.a.raw.sent;
        document.getElementById('ra-o').textContent = readerCurrent.o.raw.sent;
        
        document.getElementById('ra-full').textContent = `${readerCurrent.p.raw.sent} ... ${readerCurrent.a.raw.sent} ... ${readerCurrent.o.raw.sent}`;

        document.getElementById('reader-prompt').classList.remove('hidden');
        document.getElementById('reader-answer').classList.add('hidden');
        
        readerStart = Date.now();
    }

    function revealReader() {
        if (document.getElementById('reader-prompt').classList.contains('hidden')) return;
        const diff = (Date.now() - readerStart) / 1000;
        document.getElementById('reader-last').textContent = diff.toFixed(2) + 's';
        
        document.getElementById('reader-prompt').classList.add('hidden');
        document.getElementById('reader-answer').classList.remove('hidden');
        
        // Temp store time
        readerCurrent.time = diff;
    }

    function readerVerdict(good) {
        if (good) {
            playSound('good');
            readerHistory.push(readerCurrent.time);
            if (readerHistory.length > 20) readerHistory.shift();
            
            const avg = readerHistory.reduce((a,b)=>a+b,0) / readerHistory.length;
            document.getElementById('reader-avg').textContent = avg.toFixed(2) + 's';
            drawChart();
        } else {
            playSound('bad');
        }
        pickReaderCard();
    }

    // --- CHART ---
    function drawChart() {
        const c = document.getElementById('speedChart');
        const ctx = c.getContext('2d');
        c.width = c.clientWidth; c.height = c.clientHeight;
        const w = c.width; const h = c.height;

        ctx.clearRect(0,0,w,h);
        if (readerHistory.length < 2) return;

        ctx.beginPath();
        ctx.strokeStyle = '#00f3ff';
        ctx.lineWidth = 2;

        const max = Math.max(...readerHistory, 3);
        const step = w / (readerHistory.length - 1);

        readerHistory.forEach((val, i) => {
            const x = i * step;
            const y = h - ((val / max) * (h - 20)) - 10;
            if (i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }

    // KEYBOARD
    document.addEventListener('keydown', (e) => {
        // Time Trial
        if (document.getElementById('tab-trial').classList.contains('active')) {
            if (e.key === 'Enter' && !document.getElementById('trial-input-phase').classList.contains('hidden')) checkTrialInput();
            if (!document.getElementById('trial-verify-phase').classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') trialVerdict(false);
                if (e.key === 'ArrowRight') trialVerdict(true);
            }
        }
        // Reader
        if (document.getElementById('tab-reader').classList.contains('active')) {
            if (!document.getElementById('reader-prompt').classList.contains('hidden')) {
                if (e.code === 'Space') revealReader();
            } else {
                if (e.key === '1') readerVerdict(false);
                if (e.key === '2' || e.code === 'Space') readerVerdict(true);
            }
        }
    });

    // Boot
    init();

</script>
</body>
</html>
